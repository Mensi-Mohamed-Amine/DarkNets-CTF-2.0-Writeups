#!/bin/bash
# step 0 create jail directory & copy dependencies to jail

mkdir $HOME/Desktop/MENSI
mkdir $HOME/Desktop/MENSI/PWN_1/
mkdir $HOME/Desktop/MENSI/PWN_1/4_Broken_Shell

############################################################################
# copy your challenge binaries inside /usr/bin so that copy_to_jail script #
# find it and puts all its dependencies inside the jail folder             #
# you cant do this manually !!                                             #                                                      #
############################################################################
cp broken_shell /usr/bin

# copy_to_jail
# Define the jail directory
JAIL_DIR="$HOME/Desktop/MENSI/PWN_1/4_Broken_Shell"

# List of commands to copy
COMMANDS=("nohup" "cat" "socat" "ls" "clear" "sh" "nc" "bash" "broken_shell")

# Copy each command and its dependencies
for cmd in "${COMMANDS[@]}"; do
    # Get the full path of the command
    cmd_path=$(which "$cmd")
    if [ -z "$cmd_path" ]; then
        echo "Command '$cmd' not found. Skipping."
        continue
    fi

    # Copy the command
    mkdir -p "$JAIL_DIR$(dirname "$cmd_path")"
    cp "$cmd_path" "$JAIL_DIR$cmd_path"

    # Copy dependencies
    for lib in $(ldd "$cmd_path" | grep -o '/[^ ]*'); do
        mkdir -p "$JAIL_DIR$(dirname "$lib")"
        cp "$lib" "$JAIL_DIR$lib"
    done
done

echo "Commands and dependencies copied to jail."


# step 1 proc
sudo mkdir -p "$HOME/Desktop/MENSI/PWN_1/4_Broken_Shell/proc"
sudo mount -t proc proc "/home/debian/Desktop/MENSI/PWN_1/4_Broken_Shell/proc"

# step 2 /dev/null (necessary to run nohup command)
sudo mkdir -p $HOME/Desktop/MENSI/PWN_1/4_Broken_Shell/dev
sudo mknod -m 666 $HOME/Desktop/MENSI/PWN_1/4_Broken_Shell/dev/null c 1 3
sudo chmod 666 $HOME/Desktop/MENSI/PWN_1/4_Broken_Shell/dev/null
sudo mount --bind /dev/null $HOME/Desktop/MENSI/PWN_1/4_Broken_Shell/dev/null

# step 3 jail
sudo nsjail -Mo --chroot "$HOME/Desktop/MENSI/PWN_1/4_Broken_Shell" --disable_clone_newnet -- /usr/bin/sh

###########################################################
# NOW YOU ARE INSIDE THE JAIL : COPY & RUN THESE COMMANDS #
###########################################################

cd /usr/bin
nohup socat TCP-LISTEN:15027,reuseaddr,fork EXEC:./broken_shell > /dev/null 2>&1 &


