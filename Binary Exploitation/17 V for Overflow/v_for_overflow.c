#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define FLAG_SIZE 128

char *heap1;
char *heap2;
char *user_input;
void (*func_ptr)(void);

void print_typing_animation(const char* message) {
    const char* colors[] = {
        "\033[97m",
        "\033[31m",
        "\033[32m",
        "\033[33m",
        "\033[34m",
        "\033[35m",
        "\033[36m"
    };
    const char* reset = "\033[0m";
    int len = strlen(message);
    for (int i = 0; i < len; ++i) {
        printf("%s%c%s", colors[0], message[i], reset);
        fflush(stdout);
        usleep(100000);
    }
}

void print_banner() {
    const char* banner[] = {
    ":::::::::::::::::;++++++++++++++;:::::::::::::::::",
    ":::::::::::::xx+::::::::::::::::::+xx:::::::::::::",
    "::::::::::xx::::::::::::::::::::::::::xx::::::::::",
    "::::::::X+::::::::::::::::::::::::::::::+X::::::::",
    "::::::X+::::::::::::::::::::::::::::::::::+$::::::",
    "::::;X::::;X::::::::::::::::::::::::::X;::::X;::::",
    ":::++::++&x::::::::::::::::::::::::::::x&++::++:::",
    "::;+:;$:$x:::::::::::::::;::::::::::::::xX:&;:++::",
    "::x:;$X+$+:::::::::::::+++$;::::::::::::+$+X$;:x;:",
    ":X:xxX$+;::::::::::::::::+;::::::::::::::;+$$+x:x:",
    ";+:XX+x&::::::::::::::::::::::::::::::::::$X+XX:++",
    "X::xX$X:::::::::::::::::;;:::::::::::::::::X&Xx::X",
    "$:x;X++:::::::::::::::::++:::::::::::::::::+;X;x:X",
    "$:XX;X&:::::::::::::+&+:++:+&+:::::::::::::&X;xX:$",
    "$:;&x$+:::::::::&&&&&&::;;::&&&&&&;::::::::;$x&+:X",
    "X:+;X$:$:::::::+&&&&&&::xX::&&&&&&+:::::::$:$X++;X",
    "+x+$++x&:::::::$&&&&&&$:XX:$&&&&&&$:::::::&x+;$+++",
    ":X:;&X+&:+:::::&&&&&&&&&$&&&&&&&&&&:::::+;&+X&+:X:",
    ":;x:;+$&xxx::::&&&&&&&&&&&&&&&&&&&&::::+x+$$x;:x;:",
    "::;+;Xx;;+&+::;&&&&&&&&&&&&&&&&&&&&+::+&+;;xX+++::",
    ":::++:;&&XX$+XX&&&&&&&&&&&&&&&&&&&&X$+$XX&&;:++:::",
    "::::;X::;::xX;&&&&&&&&&&&&&&&&&&&&&&:Xx::;::X;::::",
    "::::::X+:;$&&&&&&$$&&&&&&&&&&&&$$&&&&&&&;:+$::::::",
    "::::::::X+:;;::;X&&&&&&&&&&&&&&&&X;::;;:;X::::::::",
    "::::::::::xx:::;;:X&&&&&&&&&&&&X:;;:::xx::::::::::",
    ":::::::::::::xx;:;$&&&&&&&&&&&&$;:;xx:::::::::::::",
    ":::::::::::::::::+xX$&&&&&&&&$Xx+:::::::::::::::::",
    "                   AUTHOR : DEXTER                  ",
    ""
};
    printf("\033[2J\033[H");
    for (int i = 0; banner[i][0] != '\0'; i++) {
        printf("\033[97m");
        for (int j = 0; banner[i][j] != '\0'; j++) {
            printf("%c", banner[i][j]); fflush(stdout); usleep(2000);
        }
        printf("\n"); usleep(2000);
    }
}

void victory() {
    FILE *flag_file = fopen("flag.txt", "r");
    if (flag_file) {
        char flag[FLAG_SIZE];
        fgets(flag, FLAG_SIZE, flag_file);
        printf("You win! Here's the flag:\n\033[34m%s\n", flag);
        fflush(stdout);
        fclose(flag_file);
    }
    exit(0);
}

void trigger_victory() {
    func_ptr();
}

void show_menu() {
    printf("\033[97m");
    printf("[+] [1 Show Heap     ]\n"); fflush(stdout);
    printf("[+] [2 Input Data    ]\n"); fflush(stdout);
    printf("[+] [3 Show func_ptr ]\n"); fflush(stdout);
    printf("[+] [4 Reveal Flag   ]\n"); fflush(stdout);
    printf("[+] [5 Exit          ]\n"); fflush(stdout);
    printf("[Please select an option] \n"); fflush(stdout);
}

void initialize() {
    heap1 = malloc(16);
    strncpy(heap1, "heap1_data", 16);
    heap2 = malloc(16);
    strncpy(heap2, "heap2_data", 16);
    func_ptr = (void (*)())show_menu;
}

void input_data() {
    size_t sz;
    printf("[Input buffer size (max 0x1000) ] "); fflush(stdout);
    if (scanf("%zu", &sz) != 1 || sz > 0x1000) exit(0);
    user_input = malloc(sz);
    printf("[Enter some data for heap1] "); fflush(stdout);
    scanf("%s", user_input);
}

void show_heap() {
    printf("[Heap address and contents]\n"); fflush(stdout);
    printf("[+]-------------------+---------------[+]\n"); fflush(stdout);
    printf("[+] [%p -> %s]    [+]\n", heap1, heap1); fflush(stdout);
    printf("[+] [%p -> %s]    [+]\n", heap2, heap2); fflush(stdout);
    printf("[+]-------------------+---------------[+]\n"); fflush(stdout);
}

int main() {
    initialize();
    print_banner();
    int choice;
    while (1) {
        show_menu();
        if (scanf("%d", &choice) != 1) exit(0);
        switch (choice) {
            case 1:
                show_heap();
                break;
            case 2:
                input_data();
                break;
            case 3:
                printf("[Current func_ptr points to: %p]\n", func_ptr); fflush(stdout);
                break;
            case 4:
                trigger_victory();
                break;
            case 5:
                return 0;
            default:
                printf("[Invalid choice. Try again.]\n"); fflush(stdout);
        }
    }
    return 0;
}
