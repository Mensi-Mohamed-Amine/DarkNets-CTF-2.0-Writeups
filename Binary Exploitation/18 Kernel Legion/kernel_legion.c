#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define FLAG_SIZE 64

typedef struct {
    char data[32];
    char flag[8];
} obj;

obj *global_ptr1, *global_ptr2;

void print_typing_animation(const char* message) {
    const char* colors[] = {
        "\033[97m",
        "\033[31m", 
        "\033[32m", 
        "\033[33m", 
        "\033[34m", 
        "\033[35m", 
        "\033[36m"  
    };
    const char* reset = "\033[0m"; 
    int len = strlen(message);
    

    for (int i = 0; i < len; ++i) {
        printf("%s%c%s", colors[0], message[i], reset);  
        fflush(stdout); 
        usleep(100000); 
    }

}
void print_banner() {
    const char* banner[] = {
    "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@",
    "@@@@@@@@@@@@@@@@@@#=-:::......:+%@@@@@@@@@@",
    "@@@@@@@@@@@@@@@@*=--::...........:-+@@@@@@@",
    "@@@@@@@@@@@@@@###*=-::...........:::=%@@@@@",
    "@@@@@@@@@@@@@@%%@@@%#+:....:--+++=-:-=#@@@@",
    "@@@@@@@@@@@@+-::-*@@@#-..-*%@@@@@@@@*=+%@@@",
    "@@@@@@@@@@@*-=+====%%-...-*%%*=====*%@+*@@@",
    "@@@@@@@@@@@+*@@@@@**=-..-@%=::::::::-#%*@@@",
    "@@@@@@@@@@##+==+++==:..:-=#%*#%#*#+::+%#@@@",
    "@@@@@@@@%+=-:::....:...--::=+=#@@@%#-+#%@@@",
    "@@@@@@@@#+=-::::.::...:-::.....:+**#%#=#@@@",
    "@@@@@@@%*++++*#=:+-::--:::...:::::::=+%@@@@",
    "@@@@@@%*@@%*-:-#@@@@@@#=-+%=::::::::-*%@@@@",
    "@@@@@@@@@%@@*-:::-%@@@@@*+*+:=#*--:::-*@@@@",
    "@@@@@@@@@%%@@@@@@@@%-=@@@-:::::=%@@%@@%@@@@",
    "@@@@@@@@@@#%++**#%@%**%@@@@#*++#@@@@@*@@@@@",
    "@@@@@@@@@@##@@#+=------=+*#%@@@@*#@%#@@@@@@",
    "@@@@@@@@@@*%****#@@@%#*******#@@#+%@@@@@@@@",
    "@@@@@@@@@@@@*#+=--*@@@+=+++*%@@#=#@@@@@@@@@",
    "@@@@@@@@@@@@%*+=-*@@@*-==+*%%*+%@@@@@@@@@@@",
    "@@@@@@@@@@@@@#*++%@@@+==+**+*@@@@@@@@@@@@@@",
    "@@@@@@@@@@@@@@%**%@@#+++**%@@@@@@@@@@@@@@@@",
    "@@@@@@@@@@@@@@@@%@@@##%%@@@@@@@@@@@@@@@@@@@",
    "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@",
    "@@@@@@@@@@@@@ AUTHOR : DEXTER @@@@@@@@@@@@@",
    ""
};



    const char *colors[] = {
        "\033[97m",
        "\033[31m",  
        "\033[32m",  
        "\033[33m",  
        "\033[34m",  
        "\033[35m",  
        "\033[36m",  
    };

    int num_lines = sizeof(banner) / sizeof(banner[0]);


    printf("\033[2J\033[H");

    for (int i = 0; i < num_lines; i++) {
        printf("%s", colors[0]); 
        for (int j = 0; banner[i][j] != '\0'; j++) {
            printf("%c", banner[i][j]); 
            fflush(stdout); 
            usleep(2000); 
        }
        printf("\n");
        usleep(2000);  
        
    }

  
}
void setup() {
    global_ptr1 = (obj *)malloc(sizeof(obj));
    global_ptr2 = (obj *)malloc(sizeof(obj));
    strncpy(global_ptr1->flag, "nope", 8);
    strncpy(global_ptr2->flag, "nope", 8);
    printf("Memory reserved @ %p & @ %p\n", global_ptr1, global_ptr2);
    fflush(stdout);
}

void allocate() {
    printf("\033[97m[Enter allocation size]");
    int size;
    printf("\033[97m");
    scanf("%d", &size);
    char *ptr = malloc(size);
    printf("\033[97m[Enter data]");
    fflush(stdout); 
    printf("\033[97m");
    scanf("%s", ptr);
}

void free_mem() {
    printf("\033[97m[Which memory to free? (1 or 2)]");
    fflush(stdout); 
    int choice;
    printf("\033[97m");
    scanf("%d", &choice);
    if (choice == 1) {
        free(global_ptr1);
        printf("\033[97m[Memory 1 freed!]\n");
        fflush(stdout); 
    } else if (choice == 2) {
        free(global_ptr2);
        printf("\033[97m[Memory 2 freed!]\n");
        fflush(stdout); 
    } else {
        printf("\033[97m[Invalid choice!]\n");
        fflush(stdout); 
    }
    fflush(stdout);
}

void print_heap() {
    printf("\033[97m[+] [Address: %p -> Value: %s]\n", global_ptr1->flag, global_ptr1->flag);
    fflush(stdout); 
    printf("\033[97m[+] [Address: %p -> Value: %s]\n", global_ptr2->flag, global_ptr2->flag);
    fflush(stdout);
}

void check_flag() {
    if (!strcmp(global_ptr1->flag, "1337") || !strcmp(global_ptr2->flag, "dexter")) {
        
        char buf[FLAG_SIZE];
        FILE *file = fopen("flag.txt", "r");
        if (file) {
            fgets(buf, FLAG_SIZE, file);
            printf("\033[34m%s\n", buf);
            fflush(stdout); 
            fclose(file);
        }
        exit(0);
    } else {
        printf("[Try again!]\n");
    }
}

void menu() {
    print_typing_animation("[+] [1 Allocate memory]\n");
    print_typing_animation("[+] [2 Free memory]\n");
    print_typing_animation("[+] [3 Print heap]\n");
    print_typing_animation("[+] [4 Check flag]\n");
    print_typing_animation("[+] [5 Exit]\n");
    print_typing_animation("[+] [Choice]\n");
}

int main() {
    print_banner();
    setup();
    int choice;
    while (1) {
        menu();
        printf("\033[97m");
        if (scanf("%d", &choice) != 1) exit(0);
        switch (choice) {
            case 1: allocate(); break;
            case 2: free_mem(); break;
            case 3: print_heap(); break;
            case 4: check_flag(); break;
            case 5: return 0;
            default: printf("Invalid choice!\n");
        }
    }
}
