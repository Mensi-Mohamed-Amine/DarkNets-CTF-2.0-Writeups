#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <termios.h>
#include <stdlib.h>
#define MAX_ATTEMPTS 3
#define MAX_COMMAND_LENGTH 1024

int is_root = 0;

void read_flag() {
    FILE *file = fopen("flag.txt", "r");
    if (file == NULL) {
        perror("Error opening file");
        return;
    }

    char flag[256];
    if (fgets(flag, sizeof(flag), file) != NULL) {
        printf("Flag: \033[01;96m%s\n", flag);
    } else {
        printf("Error reading flag.\n");
    }

    fclose(file);
}

void print_prompt() {
    const char *user = "amine";
    const char *hostname = "dexter";
    const char *directory = "~/Desktop";

    const char *red = "\033[0;31m";
    const char *yellow = "\033[01;33m";
    const char *green = "\033[0;32m";
    const char *blue = "\033[01;96m";
    const char *reset = "\033[0m";
    const char *bold = "\033[01m";

    const char *symbol;
    if (is_root == 1337) {
        symbol = "#";
        read_flag();
    } else {
        symbol = "$";
    }

    printf("%s┌─[%s%s@%s%s%s]-[%s%s%s]\n", 
           red, yellow, user, blue, hostname, red, 
           green, directory, red);
    fflush(stdout);

    printf("└──╼ %s%s %s", yellow, symbol, reset);
    fflush(stdout);
}

void print_dexter_info() {
    const char *dexter_info[] = {
        "Linux dexter 6.10.11-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.10.11-1dexter1 (2024-10-03) x86_64",
        "  _____            _               ____   _____ ",
        " |  __ \\          | |             / __ \\ / ____|",
        " | |  | | _____  _| |_ ___ _ __  | |  | | (___  ",
        " | |  | |/ _ \\ \\/ / __/ _ \\ '__| | |  | |\\___ \\ ",
        " | |__| |  __/>  <| ||  __/ |    | |__| |____) |",
        " |_____/ \\___/_/\\_\\\\__\\___|_|     \\____/|_____/ ",
        "",
        "",
        "",
        "",
        "The programs included with the Dexter GNU/Linux are free software;",
        "the exact distribution terms for each program are described in the",
        "individual files in /usr/share/doc/*/copyright.",
        "",
        "Dexter GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent",
        "permitted by applicable law.",
        "Last login: Mon Mar 24 06:11:40 EDT 2025 on tty2"
    };

    for (int i = 0; i < sizeof(dexter_info) / sizeof(dexter_info[0]); i++) {
        printf("%s\n", dexter_info[i]);
        fflush(stdout);
    }
}

void hide_input_password(char *password, int max_len) {
    struct termios oldt, newt;
    int i = 0;
    char ch;

    tcgetattr(STDIN_FILENO, &oldt);
    newt = oldt;
    newt.c_lflag &= ~(ECHO);
    tcsetattr(STDIN_FILENO, TCSANOW, &newt);

    printf("\033[97mpassword: ");
    fflush(stdout);
    
    while (i < max_len - 1) {
        ch = getchar();
        if (ch == '\n') {
            break;
        }
        password[i++] = ch;
    }
    password[i] = '\0';

    tcsetattr(STDIN_FILENO, TCSANOW, &oldt);
    printf("\n");
    fflush(stdout);
}

void login() {
    char username[50];
    char password[50];
    int attempts = 0;
    const char *correct_username = "dexter";
    const char *correct_password = "tty2";

    while (attempts < MAX_ATTEMPTS) {
        printf("\033[97mdexter login: ");
        fflush(stdout);
        fgets(username, sizeof(username), stdin);
        username[strcspn(username, "\n")] = '\0';

        hide_input_password(password, sizeof(password));

        if (strcmp(username, correct_username) == 0 && strcmp(password, correct_password) == 0) {
            print_dexter_info();
            return;
        } else {
            sleep(1);
            printf("\n\033[97mLogin incorrect.\n");
            fflush(stdout);
            attempts++;
        }
    }

    printf("Access denied.\n");
    fflush(stdout);
}

void read_command(char *command) {
    fgets(command, MAX_COMMAND_LENGTH, stdin);
    command[strcspn(command, "\n")] = 0;
}

void execute_command(char *command) {
    if (strcmp(command, "ls") == 0) {
        int status = system(command);
        if (status == -1) {
            perror("system");
        }
    } else if ((strcmp(command, "dexter") == 0)) {
        char pass[MAX_COMMAND_LENGTH];
        fgets(pass, MAX_COMMAND_LENGTH, stdin);
        printf(pass);
    } else if (strcmp(command,"clear")== 0) {
        int status = system(command);
        if (status == -1) {
            perror("system");
        }
    } else if (strcmp(command,"compgen -c")== 0) {
        printf("dexter\nls\nclear\n");
    }
}

int main() {
    printf("\033[2J\033[H");
    printf("\033[97mDexter Security 6.2 dexter tty2\n\n");
    fflush(stdout);
    login();

    char command[MAX_COMMAND_LENGTH];

    while (1) {
        print_prompt();
        read_command(command);

        if (strcmp(command, "exit") == 0) {
            printf("Exiting shell...\n");
            fflush(stdout);
            break;
        }

        execute_command(command);
    }
    return 0;
}
