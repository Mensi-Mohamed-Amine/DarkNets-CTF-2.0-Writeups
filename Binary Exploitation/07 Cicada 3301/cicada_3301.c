#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

void _init_() {
    __asm__ (
        "jmp %rsp;"
    );
}

void print_banner() {
    const char *banner[] = {
        "                                             Author : DEXTER                                                     ",
        "                                                                                                    ",
        "          =.-==--::==:-==:=:                        -:-.                    .     ==:-==--=-===      ",
        "        ===:=   ======- =======. :=            === ==:== ==-         --===.====================:== ==",
        "  .========:  :===-.======== =========:=.     ======:-=====      =======.=-======.====- ===   =:.=====",
        "  .======.====-...===.  .--===== :=.===   ==== ==.=.=-==.==:=====-=======.  .=:::==-===. === =-:===.. ",
        "     .. =. .==. .:=.     ..-==.=.. .=====:...==:====.:===========:====.==:   ...  ==-   .== ===:=..   ",
        "     .. . -:-. =: . :..=-. ..==-.:--=:...-...=-::..=..:=.----.=::.=.-:.-=. .-..:.:=. .--.--:-.. .    ",
        "          :.: --:.-=.::---.:::=:..-:::-: =--=-:-.  =  .-:--:. -...- -. -= .-=   .:==::-- -=.--.     ",
        "           := ====-===-=====:===-===      ::.= ==: == .=   .-===-.==.-====. .====-==--=====         ",
        "             .==== ====.==.:====.          .-= -====:.===      ===     =.  .====== =====:.         ",
        "                  .==...= ======-=          .=========== -:                == ==                   ",
        "                     .-========- .           -=====.      .            -=- -==    =:              ",
        "                      :=:======..=.           =:..======               ==- :===== .              ",
        "                     :-=-=-:.==..:=           =.:.:=:.-==  ..        ..==  ==-=-..               ",
        "                      .===.:====.==           =-:  ==.==  ==:        -.==-.====-:                ",
        "                          ======-====-:=.     === =  .==.=====     ====  =.==                    ",
        "                             =.      ===      . == =.    ....==..  =:== :                        ",
        "                                               ===-==.                                           ",
        "                                                -=                                               ",
        "                                               -:.==.                                            ",
        "                                                ::-=                                             ",
        "                                                    -.                                           ",
        "                                                                                                    ",
        "                                             CICADA 3301                                      "
    };

    const char *colors[] = {
        "\033[31m",
        "\033[32m",
        "\033[33m",
        "\033[34m",
        "\033[35m",
        "\033[36m",
    };

    int num_lines = sizeof(banner) / sizeof(banner[0]);

    printf("\033[2J\033[H");

    for (int i = 0; i < num_lines; i++) {
        printf("%s", colors[2]);
        for (int j = 0; banner[i][j] != '\0'; j++) {
            printf("%c", banner[i][j]);
            fflush(stdout);
            usleep(2000);
        }
        printf("\n");
        usleep(2000);
    }
}

void stage1() {
    printf("[Stage 1 Cryptic Number]\n");
    fflush(stdout);
    printf("What is the smallest even prime number?\n");
    fflush(stdout);
    printf(">_ ");
    fflush(stdout);
    char answer[32];
    fgets(answer, sizeof(answer), stdin);
    answer[strcspn(answer, "\n")] = 0;

    if (strcmp(answer, "2") == 0) {
        printf("Correct! Moving to Stage 2.\n\n");
        fflush(stdout);
    } else {
        printf("Incorrect answer. Try again!\n");
        fflush(stdout);
        exit(0);
    }
}

void stage2() {
    printf("[Stage 2 The Math Challenge]\n");
    fflush(stdout);
    printf("Solve the following equation:\n");
    fflush(stdout);
    printf("3x + 4 = 19\n");
    fflush(stdout);
    printf(">_ ");
    fflush(stdout);
    char answer[100];
    fgets(answer, sizeof(answer), stdin);
    answer[strcspn(answer, "\n")] = 0;

    if (strcmp(answer, "5") == 0) {
        printf("Correct! You have solved the equation.\n\n");
        fflush(stdout);
    } else {
        printf("Incorrect answer. Try again!\n");
        fflush(stdout);
        exit(0);
    }
}

void stage3() {
    printf("[Stage 3 The Word Scramble]\n");
    fflush(stdout);
    printf("Unscramble this word: 'olmpae'\n");
    fflush(stdout);
    printf(">_ ");
    fflush(stdout);
    char answer[100];
    fgets(answer, sizeof(answer), stdin);
    answer[strcspn(answer, "\n")] = 0;
    
    if (strcmp(answer, "apple") == 0) {
        printf("Correct! Moving to Stage 4.\n\n");
        fflush(stdout);
    } else {
        printf("Incorrect answer. Try again!\n");
        fflush(stdout);
        exit(0);
    }
}

void stage4() {
    printf("[Stage 4 Reverse Challenge]\n");
    fflush(stdout);
    printf("What is the reverse of the word 'level'?\n");
    fflush(stdout);
    printf(">_ ");
    fflush(stdout);
    char answer[100];
    fgets(answer, sizeof(answer), stdin);
    answer[strcspn(answer, "\n")] = 0;
    
    if (strcmp(answer, "level") == 0) {
        printf("Correct! Moving to Stage 5.\n\n");
        fflush(stdout);
    } else {
        printf("Incorrect answer. Try again!\n");
        fflush(stdout);
        exit(0);
    }
}

void stage5() {
    printf("[Stage 5 The Riddle]\n");
    fflush(stdout);
    printf("2 + 2 = ?\n");
    fflush(stdout);
    printf(">_ ");
    fflush(stdout);
    char answer[100];
    gets(answer);
    answer[strcspn(answer, "\n")] = 0;
    printf("Correct! Moving to Stage 6.\n\n");
    fflush(stdout);
}

void stage6() {
    printf("[Stage 6 Number Guessing]\n");
    fflush(stdout);
    printf("Iâ€™m thinking of a number between 1 and 100. You have 5 chances to guess the number.\n");
    fflush(stdout);
    int secret_number = 24;
    int guess, tries = 0;
    
    while (tries < 5) {
        printf(">_ ");
        fflush(stdout);
        scanf("%d", &guess);
        
        if (guess == secret_number) {
            printf("Correct! You've guessed the number!\n\n");
            fflush(stdout);
            break;
        } else if (guess < secret_number) {
            printf("Too low! Try again.\n");
            fflush(stdout);
        } else {
            printf("Too high! Try again.\n");
            fflush(stdout);
        }
        
        tries++;
    }
    
    if (tries == 5) {
        printf("Sorry, you've run out of guesses. The number was %d.\n", secret_number);
        fflush(stdout);
        exit(0);
    }
}

void stage7() {
    printf("[Stage 7 The Binary Challenge]\n");
    fflush(stdout);
    printf("Convert this binary number to decimal: 1101011010\n");
    fflush(stdout);
    printf(">_ ");
    fflush(stdout);
    
    int decimal_answer;
    scanf("%d", &decimal_answer);
    
    if (decimal_answer == 874) {
        printf("Correct! Moving to the final stage.\n\n");
        fflush(stdout);
    } else {
        printf("Incorrect answer. Try again!\n");
        fflush(stdout);
        exit(0);
    }
}

void final_stage() {
    printf("[Final Stage The Big Challenge]\n");
    fflush(stdout);
    printf("To complete this mission, you must input the password.\n");
    fflush(stdout);
    printf("Hint: The password is a color.\n");
    fflush(stdout);
    printf(">_ ");
    fflush(stdout);
    
    char answer[100];
    scanf("%99s", answer);
    answer[strcspn(answer, "\n")] = 0;
    
    if (strcmp(answer, "blue") == 0) {
        printf("Correct! You've completed the challenge. Congratulations!\n");
        fflush(stdout);
        printf("The flag is: \033[34mSecurinets{you_solved_the_ctf_task}\n");
        fflush(stdout);
    } else {
        printf("Incorrect password. You failed!\n");
        fflush(stdout);
        exit(0);
    }
}

int main() {
    print_banner();
    stage1();
    stage2();
    stage3();
    stage4();
    stage5();
    stage6();
    stage7();
    final_stage();
    return 0;
}
